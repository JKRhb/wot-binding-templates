<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <script src='https://www.w3.org/Tools/respec/respec-w3c' class='remove'></script>
    <script class='remove'>
        var respecConfig = {
            specStatus: "ED",
            group: "wg/wot",
            editors: [{
                name: "Michael Koster",
                w3cid: "110658",
                company: "SmartThings",
                companyURL: "https://www.smartthings.com/"
                },
                {
                name: "Ege Korkan",
                w3cid: "110131",
                company: "Siemens AG",
                companyURL: "https://www.siemens.com/"
                }
            ],
            edDraftURI: "https://w3c.github.io/wot-binding-templates/bindings/protocols/mqtt/",
            shortName: "wot-mqtt-binding",
            github: "https://github.com/w3c/wot-binding-templates/tree/main/bindings/protocols/mqtt",
        };
    </script>
    <title>MQTT Binding Template</title>
</head>

<body>
    <section id="abstract">
      In the context of the <a href="https://www.w3.org/TR/wot-architecture/">Web of Things (WoT)</a>, a Binding Template is 
      a blueprint that gives guidance on how to implement a specific IoT protocol, data format or IoT platform. This document 
      gives implementation guidelines regarding the <a href='https://mqtt.org/mqtt-specification/'>MQTT protocol</a>. The MQTT protocol is
      a lightweight, asynchronous, transport-independent, open protocol for publishing and subscribing to messages. It has 
      been employed in many IoT platforms and IoT applications for its simplicity and scalability.
    </section>
    <section id='introduction'>
        <h2>Introduction</h2>
        <p>
            The Message Queue Telemetry Transport (MQTT) protocol was born in 1999 to handle
            efficient machine to machine communication in the Internet of Things. The protocol
            is based on the publish subscribe model, where applications publish messages to 
            specific topics and subscribers receive notifications for filters that match one
            or more topics. The protocol is well-known for its simplicity and scalability and
            is used in many IoT platforms and applications.
            
            In the context of the Web of Things, may vendors expose MQTT based APIs mixed with 
            Web protocols like HTTP. This document describes how to describe MQTT APIs with 
            Thing Descriptions (TDs) and provide development guidance for implementers whom 
            wants to such TDs in their applications. 
        </p>
    </section>
    <section id='sotd'>
        <p>
            <em>This document is a work in progress</em>
        </p>
    </section>
    <section id="url">
      <h2>URL format</h2>
      <p class="ednote">There is no clear consensus on the correct URL format for MQTT protocol binding</p>
       <pre>
            {scheme}://{address}:{port}
        </pre>

        <p>
            Where:
            <ul>
                <li><code>{scheme}</code> is the protocol scheme, either <code>mqtt</code> or <code>mqtts</code></li>
                <li><code>{address}</code> is the IP address of the MQTT broker</li>
                <li><code>{port}</code> is the port of the MQTT broker</li>
            </ul>
        </p>
    </section>
    <section>
      <h3>MQTT Vocabulary</h3>
    <section>
      <h4>Form terms</h4>
      <table class="def">
        <thead>
          <tr>
            <th>Vocabulary term</th>
            <th>Description</th>
            <th>Assignment</th>
            <th>Type</th>
          </tr>
        </thead>
        <tbody>
          <!-- Generate forms terms from the ontology-->
          %s
        </tbody>
      </table>
    </section>
    <section id="controlpacket">
      <h4>Control Packet</h4>
      <p>
        In MQTT protocol messages are called Control Packets. An MQTT Control Packet consists of up to three parts: fixed header (present in all Control Packets), variable header, payload. 
          The fixed header consists of a packet type and flags. The main packet types that can be uses in a Form are listed below. Although, it is possible to use different
        values of [[[#controlpacket]]] in forms, it is strongly recommended to use the mapping defined in [[[#default-mappings]]].
      </p>
      <table class="def">
        <thead>
          <tr>
            <th>Value</th>
            <th>Description</th>
          </tr>
        </thead>
        <tbody>
          <!-- Generate packet values from the ontology-->
          %s
        </tbody>
      </table>
    </section>
    <section id="qualityofservice">
      <h4>QualityOfService</h4>
      <p>
        <!-- Generate qos description from the ontology-->
        %s
      </p>
      <p>
        The Quality of Service (QoS) is a mechanism to ensure that messages are delivered to the subscriber in the order in which they were published.
        In the Web of Things the QoS reported in the TD when paired with <code>writeproperty</code> or <code>invokeaction</code> operation is used to determine the
        minimum QoS that the consumer should use to publish the message. On the other hand, when paired with <code>subscribeevent</code>, <code>observeproperty</code>,
        or <code>readproperty</code>, it indicates to the subscriber that the notifications will be sent with that minium QoS.
        The QoS values are defined in the MQTT specification. The QoS values are:
      </p>
      <table class="def">
        <thead>
          <tr>
            <th>Value</th>
            <th>Name</th>
            <th>Description</th>
          </tr>
        </thead>
        <tbody>
          <!-- Generate qos values from the ontology-->
          %s
        </tbody>
      </table>
    </section>
    <section id="topicname">
      <h4>TopicName</h4>
      <p>
        <!-- Generate description form the ontology-->
        %s
      </p>
    
    </section>
    <section id="topicfilter">
      <h4>TopicFilter</h4>
      <p>
        <!-- Generate description form the ontology-->
        %s
      </p>
    
    </section>
    </section>
    <section>
      <h3>Mappings</h3>
      <p>This section describes strategies and default values to employ protocol specific concepts within the <a
          href="https://w3c.github.io/wot-architecture/#dfn-interaction-model">WoT Interaction
          model</a>. </p>
      <section id="default-mappings">
        <h3>Default mappings</h3>
      <table class="def">
        <thead>
          <tr>
            <th><code>op</code> value</th>
            <th>Default Binding</th>
          </tr>
        </thead>
        <tbody>
          <!-- Generate forms terms from the ontology-->
          %s
        </tbody>
      </table>
      </section>
      <section id="possible-mappings">
        <h3>Possible mappings</h3>
      For the MQTT protocol, if an MQTT client publishes a message to a topic with the retain flag set to true, the future subscribers of the topic will also get this message.
      Outside of this case, it is not possible to read a property but only possible to observe it. 
      <span class="rfc2119-assertion" id="iana-security-alter">Additionally, in a Form element with MQTT protocol, if the <code>op</code> contains <code>readproperty</code> (meaning that retain flag is set to true), it <em class="rfc2119" title="SHOULD">SHOULD</em> also contain <code>observeproperty</code>.</span>
      <span class="rfc2119-assertion" id="iana-security-alter">On the other hand, if the MQTT publisher does not set
        the retain flag to true, the property will be only observable. In this case, the property in the exposed Thing
        Description <em class="rfc2119" title="SHOULD NOT">SHOULD NOT</em> have Form elements with MQTT protocol containing <code>readproperty</code> operation.</span>
      </section>
  </section>
    <section>
      <h2>Examples</h2>
      <p>
        The following examples show how to use the MQTT protocol in a Thing Description. The [[[#example-simple-event]]] 
        shows a simple form that indicates to compliant clients to subscribe or unsubscribe to the topic <code>thing1/events/overheating</code>. 
      </p>
      <pre id="example-simple-event" class="example" title="Read a single coil">
        {
            "href": "mqtt://broker.com:1883",
            "op": [
                "subscribeevent",
                "unsubscribeevent"
            ],
            "mqv:filter": "thing1/events/overheating" 
        }
      </pre>
      <p>
        [[[#example-simple-publish]]] shows how to use the <code>mqv:publish</code> packet when invoking a 
        command. Remember that the <code>invokeaction</code> operation is mapped to <code>mqv:publish</code>
        control packet in [[[#default-mappings]]]. 
      </p>
      <pre id="example-simple-publish" class="example" title="Read a single coil">
        {
            "href": "mqtt://broker.com:1883",
            "op": [
                "invokeaction",
            ], 
            "mqv:topic": "application/devices/thing1/program/commands/reset",
        }
      </pre>
      <p>
        Continuing with increasingly more complex examples, [[[#example-property]]] shows how to use the MQTT protocol when handling properties.
        <code>mqv:retain</code> is used to indicate the ability to read the property rather than just observe it. 
      </p>
      <pre id="example-property" class="example" title="Read a single coil">
        {
            "href": "mqtt://broker.com:1883",
            "op": [
                "readproperty",
                "writeproperty",
                "observeproperty"
            ], 
            "mqv:retain" : true,
            "mqv:topic": "application/devices/thing1/properties/test",
            "mqv:filter": "application/devices/thing1/properties/test",
        }
      </pre>
      <p>
        If the implementer want to give the ability to WoT clients to conveniently observe all properties in a single call, it is possible
        to use observerallproperties form in the root of a Thing Description. 
      </p>
      <pre id="example-property" class="example" title="Read a single coil">
              {
                  "href": "mqtt://broker.com:1883",
                  "op": [
                      "observerallproperties"
                  ], 
                  "mqv:filter": "application/devices/thing1/properties/#",
              }
      </pre>
      <p>
        When the remote Web Thing wants to force a minimum level of [[[#qualityofservice]]] for a property, it can use the
        <code>mqv:qos</code> property in the Form element as shown in [[[#example-qos]]]. This will guarantee that consumers
        and exposers will get the message at the specified quality of service.
      </p>
      <pre id="example-qos" class="example" title="Read a single coil">
              {
                  "href": "mqtt://broker.com:1883",
                  "op": [
                      "readproperty",
                      "writeproperty",
                      "observeproperty"
                  ], 
                  "mqv:qos": "qos:1", 
                  "mqv:retain" : true,
                  "mqv:topic": "application/devices/thing1/properties/test",
                  "mqv:filter": "application/devices/thing1/properties/test",
              }
     </pre>
      <p>
        Finally, [[[#example-full]]] reports a full Thing Description for a commercial device. The broker address is only for
        demonstration purposes. 
      </p>
      <pre id="example-full" class="example" title="Read a single coil">
    {
    "@context": "https://www.w3.org/2019/wot/td/v1",
    "title": "Gas sensor",
    "id": "urn:dev:test",
    "description": "Gas sensor is a sensor that can measure combustible gas concentration and issue an alarm in the event of
        a gas leak.",
        "securityDefinitions": {
        "nosec_sc": {
            "scheme": "nosec"
        }
    },
    "security": "nosec_sc",
    "properties": {
        "status": {
            "title": "Sensor status",
            "observable": true,
            "enum": [
                "unknown",
                "warmup",
                "normal",
                "fault"
            ],
            "type": "string",
            "forms": [
                {
                    "href": "mqtt://broker.com/",
                    "mqtt:filter": "application/{{deviceid}}/sensor/operation",
                    "op": "observeproperty"
                }
            ]
        },
        "concentration": {
            "title": "Gas concentration",
            "observable": true,
            "readOnly": false,
            "minimum": -1,
            "maximum": 65535,
            "type": "integer",
            "forms": [
                {
                    "href": "mqtt://broker.com",
                    "mqtt:filter": "application/{{deviceid}}/sensor/concentration",
                    "op": "observeproperty"
                }
            ]
        },
        "gasAlarm": {
            "title": "Gas Alarm",
            "observable": true,
            "enum": [
                "unknown",
                "none",
                "mild",
                "heavy",
                "test"
            ],
            "type": "string",
            "forms": [
                {
                    "href": "mqtt://broker.com",
                    "mqtt:filter": "application/{{deviceid}}/sensor/gas",
                    "op": "observeproperty"
                }
            ]
        },
        "valve": {
            "title": "Valve",
            "observable": true,
            "enum": [
                "unknown",
                "closed",
                "opened",
                "not_connected",
                "failure",
                "closing",
                "opening",
                "checking"
            ],
            "type": "string",
            "forms": [
                {
                    "href": "mqtt://broker.com/",
                    "mqtt:filter": "application/{{deviceid}}/valve/0/state",
                    "op": "observeproperty"
                }
            ]
        }
    },
    "actions": {
        "mute": {
            "title": "Mute",
            "forms": [
                {
                    "href": "mqtt://broker.com/",
                    "mqtt:topic": "application/{{deviceid}}/sensor/mute",
                }
            ]
        },
        "unmute": {
            "title": "Unmute",
            "forms": [
                {
                    "href": "mqtt://broker.com/",
                    "mqtt:topic": "application/{{deviceid}}/sensor/unmute",
                }
            ]
        },
        "changeValveStatus": {
            "title": "Change Valve Status",
            "input": {
                "type": "string",
                "enum": [
                    "open",
                    "close"
                ]
            },
            "forms": [
                {
                    "href": "mqtt://broker.com/",
                    "mqtt:topic": "application/{{deviceid}}/valve/0/command",
                }
            ]
        }
    },
}
    </pre>
    </section>
</body>

</html>
